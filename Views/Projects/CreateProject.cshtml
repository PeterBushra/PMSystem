@model Jobick.Models.Project

@{
    Layout = "~/Views/Shared/_LayoutJobick.cshtml";
    ViewData["Title"] = "إضافة مشروع";
}

<div class="content-body content-body-rtl">
    <div class="container-fluid">
        <div class="row page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Projects")">المشاريع</a></li>
                <li class="breadcrumb-item active">
                    <a href="javascript:void(0)">
                        @(Model.Id == 0 ? "إضافة مشروع" : "تعديل مشروع")
                    </a>
                </li>
            </ol>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            @(Model.Id == 0 ? "إضافة مشروع" : "تعديل مشروع")
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="form-validation">
                            <form asp-action="PostProject" method="post" class="needs-validation" novalidate>
                                <div class="row">

                                    <!-- حقل موجز للأخطاء العامة والنموذج -->
                                    <div class="col-12">
                                        <div class="text-danger mb-3">
                                            <div asp-validation-summary="ModelOnly"></div>
                                        </div>
                                    </div>

                                    <!-- حقول مخفية للسمات غير القابلة للتحرير -->
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="CreatedDate" />
                                    <input type="hidden" asp-for="CreatedBy" />
                                    <input type="hidden" asp-for="CreatedByNavigation" />
                                    <input type="hidden" asp-for="Tasks" />

                                    <div class="col-xl-6">
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الاسم</label>
                                            <div class="col-lg-6">
                                                <input asp-for="Name" class="form-control" placeholder="اسم المشروع" required maxlength="150" />
                                                <div class="invalid-feedback">يرجى إدخال اسم المشروع.</div>
                                            </div>
                                        </div>
                              
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الوصف</label>
                                            <div class="col-lg-6">
                                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="الوصف" required maxlength="2000"></textarea>
                                                <div class="invalid-feedback">يرجى إدخال الوصف.</div>
                                            </div>
                                        </div>
                             
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الإدارة المسؤولة</label>
                                            <div class="col-lg-6">
                                                <select asp-for="ResponsibleForImplementing" class="form-control" asp-items="@ViewBag.Departments" required>
                                                    <option value="">-- اختر الإدارة --</option>
                                                </select>
                                                <div class="invalid-feedback">يرجى اختيار الإدارة المسؤولة عن التنفيذ.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required"> مالك المشروع</label>
                                            <div class="col-lg-6">
                                                <input asp-for="SystemOwner" class="form-control" placeholder="مالك المشروع" required maxlength="150" />
                                                <div class="invalid-feedback">يرجى إدخال مالك المشروع.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">هدف المشروع</label>
                                            <div class="col-lg-6">
                                                <textarea asp-for="ProjectGoal" class="form-control" rows="3" placeholder="هدف المشروع" required maxlength="150"></textarea>
                                                <div class="invalid-feedback">يرجى إدخال هدف المشروع.</div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-xl-6">
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">تاريخ البدء</label>
                                            <div class="col-lg-6">
                                                <input asp-for="StartSate" type="date" class="form-control date-rtl" required />
                                                <div class="invalid-feedback">يرجى اختيار تاريخ البدء.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">تاريخ الانتهاء</label>
                                            <div class="col-lg-6">
                                                <input asp-for="EndDate" type="date" class="form-control date-rtl" required />
                                                <span asp-validation-for="EndDate" class="text-danger"></span>
                                                <div class="invalid-feedback">يرجى اختيار تاريخ الانتهاء.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">التكلفة الإجمالية</label>
                                            <div class="col-lg-6">
                                                <input asp-for="TotalCost" type="number" step="0.01" class="form-control" placeholder="التكلفة الإجمالية" required />
                                                <div class="invalid-feedback">يرجى إدخال التكلفة الإجمالية.</div>
                                            </div>
                                        </div>


                                                         <!-- البرنامج الاستراتيجي -->
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">البرنامج الاستراتيجي</label>
                                            <div class="col-lg-6">
                                                <select asp-for="StrategicProgramme" class="form-control" id="StrategicProgramme"
                                                        required data-selected-programme="@Model?.StrategicProgramme">
                                                    <option value="">-- اختر البرنامج الاستراتيجي --</option>
                                                </select>
                                                <div class="invalid-feedback">يرجى إدخال البرنامج الاستراتيجي.</div>
                                            </div>
                                        </div>


                                        <!-- الهدف الاستراتيجي (الأب) -->
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الهدف الاستراتيجي</label>
                                            <div class="col-lg-6">
                                                <select asp-for="StrategicGoal" class="form-control" id="StrategicGoal"
                                                        required data-selected-goal="@Model?.StrategicGoal" disabled aria-disabled="true">
                                                    <option value="">-- اختر الهدف الاستراتيجي --</option>
                                                </select>
                                                <!-- الحقل المخفي لإرسال قيمة الهدف الاستراتيجي عند الإرسال -->
                                                <input type="hidden" id="StrategicGoalHidden" name="@Html.NameFor(m => m.StrategicGoal)" value="@Model?.StrategicGoal" />
                                                <div class="invalid-feedback">يرجى إدخال الهدف الاستراتيجي.</div>
                                            </div>
                                        </div>

                       
                                        @if (Model.Id != 0)
                                        {
                                            <div class="mb-3 row">
                                                <label class="col-lg-4 col-form-label form-label"> أسباب التأخر </label>
                                                <div class="col-lg-6">
                                                    <textarea asp-for="DelayReasons" class="form-control" rows="3" placeholder="أسباب التأخر" maxlength="4000"></textarea>
                                                    <div class="invalid-feedback">يرجى إدخال أسباب التأخر.</div>
                                                </div>
                                            </div>

                                        }

                                        <div class="mb-3 row">
                                            <div class="col-lg-8 ms-auto">
                                                <button type="submit" class="btn btn-primary">حفظ</button>
                                                <a href="@Url.Action("Index", "Projects")" class="btn btn-danger">إلغاء</a>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Jobick_style
{
    <link href="~/Jobick/vendor/bootstrap-datepicker-master/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="~/css/rtl-utilities.css" rel="stylesheet">
}

@section Jobick_script
{
    <script src="~/Jobick/vendor/global/global.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-datepicker-master/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Jobick/js/custom.min.js"></script>
    <script src="~/Jobick/js/dlabnav-init.js"></script>

    <script>
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        // تحقق عميلّي بأن تاريخ الانتهاء أكبر من تاريخ البدء
                        var start = form.querySelector('[name="StartSate"]').value;
                        var end = form.querySelector('[name="EndDate"]').value;
                        if (start && end && new Date(end) <= new Date(start)) {
                            event.preventDefault();
                            event.stopPropagation();
                            // إظهار رسالة خطأ تحت تاريخ الانتهاء
                            var endField = form.querySelector('[name="EndDate"]');
                            var msg = form.querySelector('[data-enddate-error]');
                            if (!msg) {
                                msg = document.createElement('div');
                                msg.className = 'text-danger mt-1';
                                msg.setAttribute('data-enddate-error', '1');
                                endField.closest('.col-lg-6').appendChild(msg);
                            }
                            msg.textContent = 'تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء.';
                        }

                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)

                    // حدّث خاصية min لتاريخ الانتهاء عند تغيير البدء
                    var startEl = form.querySelector('[name="StartSate"]');
                    var endEl = form.querySelector('[name="EndDate"]');
                    function syncMin() {
                        if (startEl && endEl && startEl.value) {
                            endEl.min = startEl.value;
                        } else if (endEl) {
                            endEl.removeAttribute('min');
                        }
                    }
                    if (startEl && endEl) {
                        startEl.addEventListener('change', syncMin);
                        // التهيئة الأولى
                        syncMin();
                    }
                })
        })()
    </script>

    <script>
        // تعبئة القوائم المنسدلة للهدف/البرنامج الاستراتيجي من ملف JSON
        // المطلوب: جعل البرنامج قابل للاختيار دائماً وعرض جميع البرامج، وعند اختيار أي برنامج يتم تحديد الهدف الأب تلقائياً
        (function () {
            const dataUrl = '@Url.Content("~/data/strategic-data.json")';
            const goalSelect = document.getElementById('StrategicGoal');
            const programmeSelect = document.getElementById('StrategicProgramme');
            const goalHidden = document.getElementById('StrategicGoalHidden');

            if (!goalSelect || !programmeSelect) return;

            let strategicData = null;
            let allProgrammes = [];

            function clearOptions(select, keepPlaceholder) {
                while (select.options.length > (keepPlaceholder ? 1 : 0)) {
                    select.remove(keepPlaceholder ? 1 : 0);
                }
            }

            function populateGoals(goals, selectedValue) {
                clearOptions(goalSelect, true);
                goals.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.name;
                    opt.textContent = g.name;
                    opt.setAttribute('data-id', g.id);
                    goalSelect.appendChild(opt);
                });
                if (selectedValue) {
                    goalSelect.value = selectedValue;
                    if (goalHidden) goalHidden.value = selectedValue;
                }
            }

            function buildAllProgrammes(goals) {
                const list = [];
                (goals || []).forEach(g => {
                    (g.programmes || []).forEach(p => {
                        list.push({
                            id: p.id,
                            name: p.name,
                            goalId: g.id,
                            goalName: g.name
                        });
                    });
                });
                return list;
            }

            function populateAllProgrammes(programmes, selectedValue) {
                clearOptions(programmeSelect, true);
                programmes.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = p.name;
                    opt.setAttribute('data-id', p.id);
                    opt.setAttribute('data-goal-id', p.goalId);
                    opt.setAttribute('data-goal-name', p.goalName);
                    programmeSelect.appendChild(opt);
                });

                if (selectedValue) {
                    const found = Array.from(programmeSelect.options).some(o => o.value === selectedValue);
                    if (!found) {
                        const custom = document.createElement('option');
                        custom.value = selectedValue;
                        custom.textContent = selectedValue + ' (قيمة قديمة)';
                        // قيم قديمة: بدون بيانات هدف، لن نغيّر الهدف تلقائياً
                        programmeSelect.appendChild(custom);
                    }
                    programmeSelect.value = selectedValue;
                }
            }

            function onGoalChanged() {
                // عند تغيير الهدف يدوياً من المستخدم، نبقي قائمة البرامج كاملة لكن نعيد تعيين الاختيار
                // أصبح الهدف الاستراتيجي للعرض فقط، لذا لا حاجة لاتخاذ إجراء هنا.
            }

            // تحميل البيانات ثم التهيئة
            fetch(dataUrl, { cache: 'no-store' })
                .then(r => r.json())
                .then(json => {
                    strategicData = json;

                    const preSelectedGoal = goalSelect.getAttribute('data-selected-goal') || '';
                    const preSelectedProgramme = programmeSelect.getAttribute('data-selected-programme') || '';

                    populateGoals(json.goals || [], preSelectedGoal);

                    allProgrammes = buildAllProgrammes(json.goals || []);
                    populateAllProgrammes(allProgrammes, preSelectedProgramme);

                    // إذا كان هناك برنامج محدد مسبقاً، اختر الهدف الأب له
                    if (preSelectedProgramme) {
                        const prog = allProgrammes.find(p => p.name === preSelectedProgramme);
                        if (prog && prog.goalName) {
                            goalSelect.value = prog.goalName; // لا نطلق حدث تغيير حتى لا نفلتر
                            if (goalHidden) goalHidden.value = prog.goalName;
                        }
                    }

                    // أحداث التغيير
                    goalSelect.addEventListener('change', function () {
                        goalSelect.setAttribute('data-user-change', '1');
                        onGoalChanged();
                        goalSelect.removeAttribute('data-user-change');
                        if (goalHidden) goalHidden.value = goalSelect.value;
                    });

                    programmeSelect.addEventListener('change', function () {
                        const selected = programmeSelect.options[programmeSelect.selectedIndex];
                        if (!selected) return;
                        const parentGoalName = selected.getAttribute('data-goal-name');
                        if (parentGoalName) {
                            // عند اختيار برنامج، حدّد الهدف الأب تلقائياً
                            goalSelect.value = parentGoalName; // لا نطلق change لتجنب تعديل قائمة البرامج
                            if (goalHidden) goalHidden.value = parentGoalName;
                        } else {
                            // لا توجد بيانات هدف للبرنامج الحالي (قيمة قديمة)
                            // لا نغيّر الهدف تلقائياً، لكن نُبقي القيمة الحالية كما هي.
                        }
                    });

                    // تأكد من تزامن الحقل المخفي مع القيمة الحالية للعرض
                    if (goalHidden && !goalHidden.value) {
                        goalHidden.value = goalSelect.value || '';
                    }
                })
                .catch(err => {
                    console.error('فشل تحميل بيانات الاستراتيجيات:', err);
                });
        })();
    </script>
}
