@model Jobick.Models.Project

@{
    Layout = "~/Views/Shared/_LayoutJobick.cshtml";
    ViewData["Title"] = "إضافة مشروع";
}

<div class="content-body content-body-rtl">
    <div class="container-fluid">
        <div class="row page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Projects")">المشاريع</a></li>
                <li class="breadcrumb-item active">
                    <a href="javascript:void(0)">
                        @(Model.Id == 0 ? "إضافة مشروع" : "تعديل مشروع")
                    </a>
                </li>
            </ol>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            @(Model.Id == 0 ? "إضافة مشروع" : "تعديل مشروع")
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="form-validation">
                            <form asp-action="PostProject" method="post" class="needs-validation" novalidate>
                                <div class="row">

                                    <!-- حقول مخفية للسمات غير القابلة للتحرير -->
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="CreatedDate" />
                                    <input type="hidden" asp-for="CreatedBy" />
                                    <input type="hidden" asp-for="CreatedByNavigation" />
                                    <input type="hidden" asp-for="Tasks" />

                                    <div class="col-xl-6">
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الاسم</label>
                                            <div class="col-lg-6">
                                                <input asp-for="Name" class="form-control" placeholder="اسم المشروع" required maxlength="150" />
                                                <div class="invalid-feedback">يرجى إدخال اسم المشروع.</div>
                                            </div>
                                        </div>
                              
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الوصف</label>
                                            <div class="col-lg-6">
                                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="الوصف" required maxlength="2000"></textarea>
                                                <div class="invalid-feedback">يرجى إدخال الوصف.</div>
                                            </div>
                                        </div>
                             
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الإدارة المسؤولة</label>
                                            <div class="col-lg-6">
                                                <select asp-for="ResponsibleForImplementing" class="form-control" asp-items="@ViewBag.Departments" required>
                                                    <option value="">-- اختر الإدارة --</option>
                                                </select>
                                                <div class="invalid-feedback">يرجى اختيار الإدارة المسؤولة عن التنفيذ.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required"> مالك المشروع</label>
                                            <div class="col-lg-6">
                                                <input asp-for="SystemOwner" class="form-control" placeholder="مالك المشروع" required maxlength="150" />
                                                <div class="invalid-feedback">يرجى إدخال مالك المشروع.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">هدف المشروع</label>
                                            <div class="col-lg-6">
                                                <textarea asp-for="ProjectGoal" class="form-control" rows="3" placeholder="هدف المشروع" required maxlength="150"></textarea>
                                                <div class="invalid-feedback">يرجى إدخال هدف المشروع.</div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-xl-6">
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">تاريخ البدء</label>
                                            <div class="col-lg-6">
                                                <input asp-for="StartSate" type="date" class="form-control date-rtl" required />
                                                <div class="invalid-feedback">يرجى اختيار تاريخ البدء.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">تاريخ الانتهاء</label>
                                            <div class="col-lg-6">
                                                <input asp-for="EndDate" type="date" class="form-control date-rtl" required />
                                                <div class="invalid-feedback">يرجى اختيار تاريخ الانتهاء.</div>
                                            </div>
                                        </div>
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">التكلفة الإجمالية</label>
                                            <div class="col-lg-6">
                                                <input asp-for="TotalCost" type="number" step="0.01" class="form-control" placeholder="التكلفة الإجمالية" required />
                                                <div class="invalid-feedback">يرجى إدخال التكلفة الإجمالية.</div>
                                            </div>
                                        </div>


                                        <!-- الهدف الاستراتيجي (الأب) -->
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">الهدف الاستراتيجي</label>
                                            <div class="col-lg-6">
                                                <select asp-for="StrategicGoal" class="form-control" id="StrategicGoal"
                                                        required data-selected-goal="@Model?.StrategicGoal">
                                                    <option value="">-- اختر الهدف الاستراتيجي --</option>
                                                </select>
                                                <div class="invalid-feedback">يرجى إدخال الهدف الاستراتيجي.</div>
                                            </div>
                                        </div>

                                        <!-- البرنامج الاستراتيجي (الابن) -->
                                        <div class="mb-3 row">
                                            <label class="col-lg-4 col-form-label form-label required">البرنامج الاستراتيجي</label>
                                            <div class="col-lg-6">
                                                <select asp-for="StrategicProgramme" class="form-control" id="StrategicProgramme"
                                                        required data-selected-programme="@Model?.StrategicProgramme" disabled>
                                                    <option value="">-- اختر البرنامج الاستراتيجي --</option>
                                                </select>
                                                <div class="invalid-feedback">يرجى إدخال البرنامج الاستراتيجي.</div>
                                            </div>
                                        </div>

                                        @if (Model.Id != 0)
                                        {
                                            <div class="mb-3 row">
                                                <label class="col-lg-4 col-form-label form-label"> أسباب التأخر </label>
                                                <div class="col-lg-6">
                                                    <textarea asp-for="DelayReasons" class="form-control" rows="3" placeholder="أسباب التأخر" maxlength="4000"></textarea>
                                                    <div class="invalid-feedback">يرجى إدخال أسباب التأخر.</div>
                                                </div>
                                            </div>

                                        }

                                        <div class="mb-3 row">
                                            <div class="col-lg-8 ms-auto">
                                                <button type="submit" class="btn btn-primary">حفظ</button>
                                                <a href="@Url.Action("Index", "Projects")" class="btn btn-danger">إلغاء</a>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Jobick_style
{
    <link href="~/Jobick/vendor/bootstrap-datepicker-master/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="~/css/rtl-utilities.css" rel="stylesheet">
}

@section Jobick_script
{
    <script src="~/Jobick/vendor/global/global.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-datepicker-master/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Jobick/js/custom.min.js"></script>
    <script src="~/Jobick/js/dlabnav-init.js"></script>

    <script>
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    </script>

    <script>
        // تعبئة القوائم المنسدلة للهدف/البرنامج الاستراتيجي من ملف JSON وعلاقة أب/ابن
        (function () {
            const dataUrl = '@Url.Content("~/data/strategic-data.json")';
            const goalSelect = document.getElementById('StrategicGoal');
            const programmeSelect = document.getElementById('StrategicProgramme');

            if (!goalSelect || !programmeSelect) return;

            let strategicData = null;

            function clearOptions(select, keepPlaceholder) {
                while (select.options.length > (keepPlaceholder ? 1 : 0)) {
                    select.remove(keepPlaceholder ? 1 : 0);
                }
            }

            function enable(select, enabled) {
                select.disabled = !enabled;
            }

            function populateGoals(goals, selectedValue) {
                clearOptions(goalSelect, true);
                goals.forEach(g => {
                    const opt = document.createElement('option');
                    // نخزن الاسم كقيمة لربطها مع خاصية السجل النصية
                    opt.value = g.name;
                    opt.textContent = g.name;
                    opt.setAttribute('data-id', g.id);
                    goalSelect.appendChild(opt);
                });
                if (selectedValue) {
                    goalSelect.value = selectedValue;
                }
            }

            function populateProgrammes(programmes, selectedValue) {
                clearOptions(programmeSelect, true);
                programmes.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name; // القيمة النصية للحفظ في قاعدة البيانات
                    opt.textContent = p.name;
                    opt.setAttribute('data-id', p.id);
                    programmeSelect.appendChild(opt);
                });
                if (selectedValue) {
                    // إذا لم يوجد في القائمة (بيانات قديمة)، أضفه كخيار مخصص
                    const found = Array.from(programmeSelect.options).some(o => o.value === selectedValue);
                    if (!found) {
                        const custom = document.createElement('option');
                        custom.value = selectedValue;
                        custom.textContent = selectedValue + ' (قيمة قديمة)';
                        programmeSelect.appendChild(custom);
                    }
                    programmeSelect.value = selectedValue;
                }
                enable(programmeSelect, true);
            }

            function onGoalChanged() {
                const selectedGoalName = goalSelect.value;
                clearOptions(programmeSelect, true);
                enable(programmeSelect, false);

                if (!selectedGoalName) return;

                const goal = strategicData?.goals?.find(g => g.name === selectedGoalName);
                if (goal) {
                    populateProgrammes(goal.programmes || [], programmeSelect.getAttribute('data-selected-programme'));
                }
            }

            // تحميل البيانات ثم التهيئة
            fetch(dataUrl, { cache: 'no-store' })
                .then(r => r.json())
                .then(json => {
                    strategicData = json;

                    const preSelectedGoal = goalSelect.getAttribute('data-selected-goal') || '';
                    const preSelectedProgramme = programmeSelect.getAttribute('data-selected-programme') || '';

                    populateGoals(json.goals || [], preSelectedGoal);

                    if (preSelectedGoal) {
                        const g = (json.goals || []).find(x => x.name === preSelectedGoal);
                        if (g) {
                            populateProgrammes(g.programmes || [], preSelectedProgramme);
                        }
                    }

                    goalSelect.addEventListener('change', function () {
                        // عند تغيير الهدف، نفرغ قيمة البرنامج حتى يُعاد الاختيار
                        programmeSelect.value = '';
                        programmeSelect.setAttribute('data-selected-programme', '');
                        onGoalChanged();
                    });
                })
                .catch(err => {
                    // في حال فشل التحميل، نبقي الحقول نصية كخطة بديلة
                    console.error('فشل تحميل بيانات الاستراتيجيات:', err);
                });
        })();
    </script>
}
