@model Jobick.ViewModels.ProjectStatisticsVM
@using System.Text.Json
@{
    // Check if there's any project progress data to display
    var hasData = Model.ProjectProgressDetails.Any();
    
    // Get unique years and projects from the data
    var availableYears = Model.ProjectProgressDetails.Select(p => p.Year).Distinct().OrderBy(y => y).ToList();
    var availableProjects = Model.ProjectProgressDetails
        .Select(p => new { p.ProjectId, p.ProjectName })
        .Distinct()
        .OrderBy(p => p.ProjectName)
        .ToList();
    
    // Get current year and quarter
    var currentYear = DateTime.Now.Year;
    var currentQuarter = (DateTime.Now.Month - 1) / 3 + 1;
    var currentQuarterKey = $"Q{currentQuarter}";
    
    // Determine default year (current year if available, otherwise first available)
    var defaultYear = availableYears.Contains(currentYear) ? currentYear : (availableYears.Any() ? availableYears.First() : currentYear);
    
    // Determine default project (first in list if available)
    var defaultProjectId = availableProjects.Any() ? availableProjects.First().ProjectId : 0;
    
    // Serialize data for JavaScript
    var projectProgressJson = JsonSerializer.Serialize(Model.ProjectProgressDetails);
}

<div class="row mt-4">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                <h4 class="card-title mb-2 mb-md-0">تتبع الإنجاز التفصيلي للمشاريع</h4>
                @if (hasData)
                {
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <label for="detailedYearFilter" class="me-2 mb-0">السنة:</label>
                        <select id="detailedYearFilter" class="form-select form-select-sm d-inline-block w-auto">
                            @foreach (var year in availableYears)
                            {
                                @if (year == defaultYear)
                                {
                                    <option value="@year" selected>@year</option>
                                }
                                else
                                {
                                    <option value="@year">@year</option>
                                }
                            }
                        </select>
                        
                        <label for="detailedQuarterFilter" class="me-2 mb-0 ms-3">الربع:</label>
                        <select id="detailedQuarterFilter" class="form-select form-select-sm d-inline-block w-auto">
                            @if (currentQuarterKey == "Q1")
                            {
                                <option value="Q1" selected>الربع الأول</option>
                            }
                            else
                            {
                                <option value="Q1">الربع الأول</option>
                            }
                            
                            @if (currentQuarterKey == "Q2")
                            {
                                <option value="Q2" selected>الربع الثاني</option>
                            }
                            else
                            {
                                <option value="Q2">الربع الثاني</option>
                            }
                            
                            @if (currentQuarterKey == "Q3")
                            {
                                <option value="Q3" selected>الربع الثالث</option>
                            }
                            else
                            {
                                <option value="Q3">الربع الثالث</option>
                            }
                            
                            @if (currentQuarterKey == "Q4")
                            {
                                <option value="Q4" selected>الربع الرابع</option>
                            }
                            else
                            {
                                <option value="Q4">الربع الرابع</option>
                            }
                        </select>

                        <div class="form-check form-check-inline ms-3">
                            <input class="form-check-input" type="checkbox" id="detailedAnnualView">
                            <label class="form-check-label mb-0" for="detailedAnnualView">عرض سنوي</label>
                        </div>
                        
                        <label for="detailedProjectFilter" class="me-2 mb-0 ms-3">المشروع:</label>
                        <select id="detailedProjectFilter" class="form-select form-select-sm d-inline-block w-auto" style="min-width: 200px;">
                            <option value="">جميع المشاريع</option>
                            @foreach (var project in availableProjects)
                            {
                                @if (project.ProjectId == defaultProjectId)
                                {
                                    <option value="@project.ProjectId" selected>@project.ProjectName</option>
                                }
                                else
                                {
                                    <option value="@project.ProjectId">@project.ProjectName</option>
                                }
                            }
                        </select>
                    </div>
                }
            </div>
            <div class="card-body">
                @if (!hasData)
                {
                    <div class="alert alert-info text-center mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        لا توجد بيانات إنجاز تفصيلية للمشاريع المطابقة للتصفية الحالية.
                    </div>
                }
                else
                {
                    <div id="detailedProgressChart" style="min-height: 360px;"></div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>النسبة المستهدفة السنوية:</strong> مجموع أوزان جميع المهام للسنة المحددة<br />
                            <strong>النسبة المستهدفة حسب الربع:</strong> مجموع أوزان مهام الربع المحدد<br />
                            <strong>النسبة الفعلية:</strong> مجموع (وزن المهمة × نسبة الإنجاز الفعلية) للمهام داخل الربع المحدد<br />
                            <span class="د-inline-block mt-2">
                                <span class="badge bg-success me-2">أخضر</span> الإنجاز الفعلي أعلى من المستهدف - حقق المستهدف
                                <span class="badge bg-warning text-dark me-2 ms-3">أصفر</span> الإنجاز أقل من المستهدف بـ 1-4%
                                <span class="badge bg-danger me-2 ms-3">أحمر</span> الإنجاز أقل من المستهدف بـ 5% أو أكثر
                            </span>
                        </small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (hasData)
{
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if ApexCharts is loaded, if not wait for it
            function initDetailedChart() {
                if (typeof ApexCharts === 'undefined') {
                    // ApexCharts not loaded yet, wait a bit and try again
                    setTimeout(initDetailedChart, 100);
                    return;
                }
                
                const projectProgressData = @Html.Raw(projectProgressJson);
                
                const detailedYearFilter = document.getElementById('detailedYearFilter');
                const detailedQuarterFilter = document.getElementById('detailedQuarterFilter');
                const detailedProjectFilter = document.getElementById('detailedProjectFilter');
                const detailedAnnualView = document.getElementById('detailedAnnualView');
                const quarterLabel = document.querySelector('label[for="detailedQuarterFilter"]');
                const chartEl = document.querySelector("#detailedProgressChart");
                
                let detailedProgressChart = null;
                let aggregatedData = null; // used in annual view tooltips
                
                // Function to determine color based on performance
                function getProgressColor(actual, target) {
                    const diff = target - actual;
                    
                    if (actual >= target) {
                        return '#28a745'; // Green - meeting or exceeding target
                    } else if (diff >= 1 && diff <= 4) {
                        return '#ffc107'; // Yellow - 1-4% below target
                    } else {
                        return '#dc3545'; // Red - 5% or more below target
                    }
                }
                
                // Escape HTML helper to avoid injection in tooltip
                function escapeHtml(str) {
                    if (str == null) return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }
                
                // Helper: render delay reasons list as badges with proper wrapping
                function renderDelayReasons(reasons) {
                    if (!reasons) return '';
                    // Split by common separators and trim
                    const items = reasons
                        .split(/[,;\n]+/)
                        .map(s => s.trim())
                        .filter(Boolean)
                        .slice(0, 8); // limit to avoid overly long tooltips

                    if (items.length === 0) return '';

                    const badges = items.map(r => `
                        <span class=\"badge rounded-pill bg-light text-dark border\"
                              style=\"display:inline-block; white-space: normal; word-break: break-word; overflow-wrap: anywhere; max-width: 100%;\">\n                            ${escapeHtml(r)}\n                        </span>
                    `).join('');

                    return `
                        <div class=\"mt-2\" style=\"white-space: normal; overflow-wrap: anywhere; word-break: break-word;\">\n                            <small class=\"text-muted d-block mb-1\">أسباب التأخير:</small>\n                            <div class=\"d-flex flex-wrap gap-1\">${badges}</div>\n                        </div>`;
                }
                
                function updateQuarterVisibility(isAnnual) {
                    if (quarterLabel) quarterLabel.style.display = isAnnual ? 'none' : '';
                    if (detailedQuarterFilter) {
                        detailedQuarterFilter.style.display = isAnnual ? 'none' : '';
                        detailedQuarterFilter.disabled = !!isAnnual;
                    }
                }
                
                function renderDetailedChart() {
                    const selectedYear = detailedYearFilter.value;
                    const selectedQuarter = detailedQuarterFilter.value;
                    const selectedProject = detailedProjectFilter.value;
                    const isAnnual = detailedAnnualView && detailedAnnualView.checked;

                    updateQuarterVisibility(isAnnual);
                    
                    // Validation: Year is required, Quarter is required only if not annual
                    if (!selectedYear || (!isAnnual && !selectedQuarter)) {
                        if (chartEl) {
                            chartEl.innerHTML = '<div class="alert alert-info text-center">الرجاء اختيار السنة' + (isAnnual ? '' : ' والربع السنوي') + '</div>';
                        }
                        return;
                    }
                    
                    let categories = [];
                    let annualTargets = [];
                    let quarterTargets = [];
                    let actualProgress = [];
                    let actualColors = [];
                    aggregatedData = null;

                    if (isAnnual) {
                        // Filter by year (and project optionally), then aggregate by project over all quarters
                        let yearData = projectProgressData.filter(item => item.Year.toString() === selectedYear);
                        if (selectedProject) {
                            yearData = yearData.filter(item => item.ProjectId.toString() === selectedProject);
                        }

                        if (yearData.length === 0) {
                            if (chartEl) {
                                chartEl.innerHTML = '<div class="alert alert-warning text-center">لا توجد بيانات للمعايير المحددة</div>';
                            }
                            return;
                        }

                        // Group by ProjectId and accumulate quarterly values; compute a reliable annual target
                        const map = new Map();
                        for (const item of yearData) {
                            const key = String(item.ProjectId);
                            const annualTarget = Number(item.AnnualTargetProgress) || 0;
                            const quarterTarget = Number(item.QuarterTargetProgress) || 0;
                            const actual = Number(item.ActualProgress) || 0;
                            if (!map.has(key)) {
                                map.set(key, {
                                    ProjectId: item.ProjectId,
                                    ProjectName: item.ProjectName,
                                    AnnualTargetProgress: annualTarget, // from data; may be 0
                                    SumQuarterTarget: 0,
                                    ActualSumRaw: 0,
                                    DelayReasons: []
                                });
                            }
                            const g = map.get(key);
                            // Prefer a non-zero annual target; keep the max seen
                            if (annualTarget > g.AnnualTargetProgress) g.AnnualTargetProgress = annualTarget;
                            g.SumQuarterTarget += quarterTarget;
                            // Only count actual based on TaskLog presence (actual > 0), independent of targets
                            if (actual > 0) {
                                g.ActualSumRaw += actual;
                                if (item.DelayReasons) g.DelayReasons.push(item.DelayReasons);
                            }
                        }

                        // Finalize: choose target (annual if present, else sum of quarters). Do NOT cap actual; rely solely on TaskLogs
                        aggregatedData = Array.from(map.values()).map(g => {
                            const target = g.AnnualTargetProgress > 0 ? g.AnnualTargetProgress : g.SumQuarterTarget;
                            return {
                                ...g,
                                TargetFinal: target,
                                ActualFinal: g.ActualSumRaw
                            };
                        }).sort((a, b) => (a.ProjectName || '').localeCompare(b.ProjectName || ''));

                        categories = aggregatedData.map(g => g.ProjectName);
                        annualTargets = aggregatedData.map(g => g.TargetFinal);
                        actualProgress = aggregatedData.map(g => g.ActualFinal);
                        actualColors = aggregatedData.map(g => getProgressColor(g.ActualFinal, g.TargetFinal));

                    } else {
                        // Quarterly view (original behavior)
                        // Filter data based on selections (year/quarter for targets and actual; optional project filter)
                        let filteredData = projectProgressData.filter(item => {
                            let match = item.Year.toString() === selectedYear && item.Quarter === selectedQuarter;
                            if (selectedProject) {
                                match = match && item.ProjectId.toString() === selectedProject;
                            }
                            return match;
                        });
                        
                        if (filteredData.length === 0) {
                            if (chartEl) {
                                chartEl.innerHTML = '<div class="alert alert-warning text-center">لا توجد بيانات للمعايير المحددة</div>';
                            }
                            return;
                        }
                        
                        // Prepare chart data
                        categories = filteredData.map(item => item.ProjectName);
                        annualTargets = filteredData.map(item => item.AnnualTargetProgress);
                        quarterTargets = filteredData.map(item => item.QuarterTargetProgress);
                        actualProgress = filteredData.map(item => Number(item.ActualProgress) || 0);
                        
                        // Calculate colors for actual progress bars (compare actual vs selected quarter target)
                        actualColors = filteredData.map(item => 
                            getProgressColor(Number(item.ActualProgress) || 0, item.QuarterTargetProgress)
                        );
                    }
                    
                    const isAnnualNow = (detailedAnnualView && detailedAnnualView.checked);
                    
                    const options = {
                        chart: { 
                            type: 'bar', 
                            height: 400, 
                            toolbar: { show: false }, 
                            fontFamily: 'inherit' 
                        },
                        series: isAnnualNow
                            ? [
                                { name: 'النسبة المستهدفة السنوية', data: annualTargets },
                                { name: 'النسبة الفعلية', data: actualProgress }
                              ]
                            : [
                                { name: 'النسبة المستهدفة السنوية', data: annualTargets },
                                { name: 'النسبة المستهدفة حسب الربع', data: quarterTargets },
                                { name: 'النسبة الفعلية', data: actualProgress }
                              ],
                        colors: isAnnualNow
                            ? ['#17a2b8', function({ value, seriesIndex, dataPointIndex }) {
                                  if (seriesIndex === 1) { return actualColors[dataPointIndex]; }
                                  return '#28a745';
                              }]
                            : ['#17a2b8', '#6c757d', function({ value, seriesIndex, dataPointIndex }) {
                                  if (seriesIndex === 2) { return actualColors[dataPointIndex]; }
                                  return '#28a745';
                              }],
                        xaxis: { 
                            categories: categories,
                            labels: { 
                                style: { 
                                    colors: '#6c757d', 
                                    fontSize: '12px' 
                                },
                                rotate: -45,
                                rotateAlways: categories.length > 3,
                                trim: true,
                                hideOverlappingLabels: true
                            }
                        },
                        yaxis: { 
                            title: {
                                text: 'نسبة الإنجاز (%)',
                                style: { fontSize: '12px', fontWeight: 500 }
                            },
                            labels: { 
                                style: { colors: '#6c757d', fontSize: '12px' },
                                formatter: (v) => v ? v.toFixed(1) + '%' : '0%'
                            }
                        },
                        plotOptions: { 
                            bar: { 
                                columnWidth: '70%', 
                                borderRadius: 4,
                                dataLabels: {
                                    position: 'top'
                                }
                            }
                        },
                        dataLabels: { 
                            enabled: true, 
                            formatter: (val) => val ? val.toFixed(1) + '%' : '0%', 
                            style: { 
                                fontSize: '10px', 
                                fontWeight: '600',
                                colors: ['#000']
                            },
                            offsetY: -20
                        },
                        stroke: { 
                            show: true, 
                            width: 2, 
                            colors: ['transparent'] 
                        },
                        grid: { 
                            strokeDashArray: 6, 
                            borderColor: 'var(--border, #e5e5e5)',
                            padding: {
                                right: 20,
                                left: 10
                            }
                        },
                        legend: { 
                            position: 'top', 
                            horizontalAlign: 'right',
                            markers: { width: 10, height: 10 },
                            itemMargin: {
                                horizontal: 10,
                                vertical: 5
                            }
                        },
                        tooltip: { 
                            shared: true,
                            intersect: false,
                            followCursor: true,
                            y: { 
                                formatter: (v) => v ? v.toFixed(2) + '%' : '0%'
                            },
                            custom: function({ series, seriesIndex, dataPointIndex }) {
                                if (isAnnualNow) {
                                    const data = aggregatedData[dataPointIndex];
                                    const actual = Number(data.ActualFinal) || 0;
                                    const target = Number(data.TargetFinal) || 0;
                                    const diff = target - actual;
                                    const diffPercent = diff.toFixed(2);

                                    let statusText = '';
                                    let statusClass = '';

                                    if (actual > target) {
                                        statusText = `متفوق على المستهدف بـ ${(actual - target).toFixed(2)}%`;
                                        statusClass = 'text-success';
                                    } else if (actual === target) {
                                       statusText = 'حققت المستهدف';
                                       statusClass = 'text-success';
                                    } else if (diff >= 1 && diff <= 4) {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-warning';
                                    } else if (diff > 4) {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-danger';
                                    } else {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-warning';
                                    }

                                    // Aggregate delay reasons across quarters that had TaskLog data
                                    let allReasons = '';
                                    if (Array.isArray(data.DelayReasons) && data.DelayReasons.length) {
                                        const joined = data.DelayReasons.join(',');
                                        const parts = joined.split(/[,;\n]+/).map(s => s.trim()).filter(Boolean);
                                        const uniq = Array.from(new Set(parts));
                                        allReasons = uniq.join(', ');
                                    }
                                    const reasonsHtml = (diff > 0) ? renderDelayReasons(allReasons) : '';
                                    
                                    return `
                                        <div class="apexcharts-tooltip-custom p-2"
                                             style="background:#fff; border:1px solid #e3e3e3; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); width:min(90vw, 600px); max-width:600px; padding:10px 12px; direction: rtl; text-align: start;">
                                            <div class="d-flex justify-content-between align-items-center" style="gap:8px; flex-wrap:wrap;">
                                                <div style="font-weight:600; word-break: break-word; overflow-wrap:anywhere;">${escapeHtml(data.ProjectName)}</div>
                                                <span class="badge ${statusClass.replace('text-','bg-')}">عرض سنوي</span>
                                            </div>
                                            <div class="mt-2">النسبة السنوية المستهدفة: <strong>${target.toFixed(1)}%</strong></div>
                                            <div>الإنجاز الفعلي (سنة ${escapeHtml(selectedYear)}): <strong>${actual.toFixed(1)}%</strong></div>
                                            <div class="mt-1 ${statusClass}"><strong>${statusText}</strong></div>
                                            ${reasonsHtml}
                                        </div>
                                    `;
                                } else {
                                    // Quarterly tooltip (original)
                                    const data = (function() {
                                        // Reconstruct the filtered set used above to keep scope simple
                                        const selectedYearL = detailedYearFilter.value;
                                        const selectedQuarterL = detailedQuarterFilter.value;
                                        const selectedProjectL = detailedProjectFilter.value;
                                        let filtered = projectProgressData.filter(item => {
                                            let match = item.Year.toString() === selectedYearL && item.Quarter === selectedQuarterL;
                                            if (selectedProjectL) match = match && item.ProjectId.toString() === selectedProjectL;
                                            return match;
                                        });
                                        return filtered[dataPointIndex];
                                    })();

                                    const actual = Number(data.ActualProgress) || 0;
                                    const diff = data.QuarterTargetProgress - actual;
                                    const diffPercent = diff.toFixed(2);
                                    
                                    let statusText = '';
                                    let statusClass = '';
                                    
                                    if (actual > data.QuarterTargetProgress) {
                                        statusText = `متفوق على المستهدف بـ ${(actual - data.QuarterTargetProgress).toFixed(2)}%`;
                                        statusClass = 'text-success';
                                    } else if (actual === data.QuarterTargetProgress) {
                                       statusText = 'حقق المستهدف';
                                       statusClass = 'text-success';
                                    }
                                    else if (diff >= 1 && diff <= 4) {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-warning';
                                    } else if (diff > 4) {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-danger';
                                    } else {
                                        statusText = `أقل من المستهدف بـ ${diffPercent}%`;
                                        statusClass = 'text-warning';
                                    }

                                    const reasonsHtml = (diff > 0) ? renderDelayReasons(data.DelayReasons) : '';
                                    
                                    return `
                                        <div class="apexcharts-tooltip-custom p-2"
                                             style="background:#fff; border:1px solid #e3e3e3; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); width:min(90vw, 600px); max-width:600px; padding:10px 12px; direction: rtl; text-align: start;">
                                            <div class="d-flex justify-content-between align-items-center" style="gap:8px; flex-wrap:wrap;">
                                                <div style="font-weight:600; word-break: break-word; overflow-wrap:anywhere;">${escapeHtml(data.ProjectName)}</div>
                                                <span class="badge ${statusClass.replace('text-','bg-')}">${escapeHtml(data.Quarter)}</span>
                                            </div>
                                            <div class="mt-2">النسبة السنوية: <strong>${Number(data.AnnualTargetProgress).toFixed(1)}%</strong></div>
                                            <div>المستهدف (الربع): <strong>${Number(data.QuarterTargetProgress).toFixed(1)}%</strong></div>
                                            <div>الإنجاز الفعلي: <strong>${Number(actual).toFixed(1)}%</strong></div>
                                            <div class="mt-1 ${statusClass}"><strong>${statusText}</strong></div>
                                            ${reasonsHtml}
                                        </div>
                                    `;
                                }
                            }
                        }
                    };
                    
                    // Clear existing chart
                    if (detailedProgressChart) {
                        detailedProgressChart.destroy();
                    }
                    
                    // Clear any alert messages
                    if (chartEl) {
                        chartEl.innerHTML = '';
                        detailedProgressChart = new ApexCharts(chartEl, options);
                        detailedProgressChart.render();
                    }
                }
                
                // Event listeners for filters
                if (detailedYearFilter) {
                    detailedYearFilter.addEventListener('change', renderDetailedChart);
                }
                
                if (detailedQuarterFilter) {
                    detailedQuarterFilter.addEventListener('change', renderDetailedChart);
                }
                
                if (detailedProjectFilter) {
                    detailedProjectFilter.addEventListener('change', renderDetailedChart);
                }

                if (detailedAnnualView) {
                    detailedAnnualView.addEventListener('change', renderDetailedChart);
                }
                
                // Initial render with default values (current year, current quarter, first project)
                renderDetailedChart();
            }
            
            // Start initialization
            initDetailedChart();
        });
    </script>
}
