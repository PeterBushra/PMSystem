@model Jobick.Models.Task
@{
    Layout = "~/Views/Shared/_LayoutJobick.cshtml";
    ViewData["Title"] = Model.Id == 0 ? "إضافة مهمة" : "تعديل مهمة";

    decimal? projectTotalCost = ViewBag.ProjectTotalCost as decimal?;
    bool hasProjectTotal = (ViewBag.HasProjectTotal as bool?) ?? false;
    decimal existingTasksCost = (ViewBag.ExistingTasksCost as decimal?) ?? 0m;
    decimal otherTasksWeight = (ViewBag.OtherTasksWeight as decimal?) ?? 0m;

    var initialShowAttachment = Model.DoneRatio.HasValue && Model.DoneRatio.Value >= 100m;

    // Pre-format values once and pass to partials via ViewData to avoid recomputation
    ViewData["OtherTasksWeightFormatted"] = otherTasksWeight.ToString("N2");
    ViewData["RemainingWeightFormatted"] = Math.Max(100m - otherTasksWeight, 0m).ToString("N2");
    ViewData["RemainingCostBeforeFormatted"] = hasProjectTotal
        ? Math.Max(projectTotalCost.GetValueOrDefault() - existingTasksCost, 0).ToString("N2")
        : "غير محدد";
    ViewData["HasProjectTotal"] = hasProjectTotal;
    ViewData["ProjectTotalCost"] = projectTotalCost;
    ViewData["ExistingTasksCost"] = existingTasksCost;
    ViewData["OtherTasksWeight"] = otherTasksWeight;
    ViewData["InitialShowAttachment"] = initialShowAttachment;
}

<div class="content-body content-body-rtl">
    <div class="container-fluid">
        <div class="row page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("ProjectDetails", "Projects", new { id = Model.ProjectId })">تفاصيل المشروع</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">@ViewData["Title"]</a></li>
            </ol>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">@ViewData["Title"]</h4>
                    </div>
                    <div class="card-body">
                        <form asp-action="@(Model.Id == 0 ? "PostTask" : "EditTask")" method="post" enctype="multipart/form-data" class="needs-validation" novalidate
                              data-project-total="@(((bool)ViewData["HasProjectTotal"] ? ((decimal?)ViewData["ProjectTotalCost"])?.ToString(System.Globalization.CultureInfo.InvariantCulture) : ""))"
                              data-has-total="@(((bool)ViewData["HasProjectTotal"]).ToString().ToLower())"
                              data-existing-cost="@(((decimal)ViewData["ExistingTasksCost"]).ToString(System.Globalization.CultureInfo.InvariantCulture))"
                              data-other-weight-sum="@(((decimal)ViewData["OtherTasksWeight"]).ToString(System.Globalization.CultureInfo.InvariantCulture))"
                              data-has-existing-attachment="@((!string.IsNullOrEmpty(Model.AttachmentFilePath) && Model.Id != 0).ToString().ToLower())">
                            <input type="hidden" asp-for="Id" />
                            <input type="hidden" asp-for="ProjectId" />
                            <input type="hidden" asp-for="CreatedDate" />
                            <input type="hidden" asp-for="CreatedBy" />
                            <input type="hidden" asp-for="Project" />
                            <input type="hidden" asp-for="CreatedByNavigation" />
                            <input type="hidden" asp-for="AttachmentFileName" />
                            <input type="hidden" asp-for="AttachmentFilePath" />

                            <!-- Wizard header (steps) -->
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                <ul class="nav nav-pills" id="stepsNav">
                                    <li class="nav-item"><button type="button" class="nav-link active" data-step="0">1. بيانات المهمة</button></li>
                                    <li class="nav-item"><button type="button" class="nav-link" data-step="1">2. التخطيط والميزانية</button></li>
                                    <li class="nav-item"><button type="button" class="nav-link" data-step="2">3. التقدم والمرفقات</button></li>
                                    <li class="nav-item"><button type="button" class="nav-link" data-step="3">4. المراجعة والحفظ</button></li>
                                </ul>
                                <small class="text-muted" id="stepCaption">الخطوة 1 من 4</small>
                            </div>

                            <div id="stepsContainer">
                                @Html.Partial("_TaskStepBasic", Model)
                                @Html.Partial("_TaskStepPlanning", Model)
                                @Html.Partial("_TaskStepProgressAttachment", Model)
                                @Html.Partial("_TaskStepReviewSave", Model)
                            </div>

                            <!-- Wizard footer navigation -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <button type="button" class="btn btn-light" id="prevStepBtn" disabled>السابق</button>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" id="nextStepBtn">التالي</button>
                                    <button type="submit" class="btn btn-success d-none" id="saveBtn">حفظ</button>
                                    <a href="@Url.Action("ProjectDetails", "Projects", new { id = Model.ProjectId })" class="btn btn-secondary">إلغاء</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Jobick_script {
    <script src="~/Jobick/vendor/global/global.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="~/Jobick/vendor/bootstrap-datepicker-master/js/bootstrap-datepicker.min.js"></script>
    <script src="~/Jobick/js/custom.min.js"></script>
    <script src="~/Jobick/js/dlabnav-init.js"></script>
    <script src="~/Jobick/js/task-wizard.js"></script>
}
